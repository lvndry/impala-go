<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <title>Go Impala</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.css">

    <script type="text/javascript" src="../script/goreleaser.js"></script>
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>if (window.module) module = window.module;</script>
  </head>

  <body>
    <section class="section">

      <nav class="level">
         <div class="level-left">
         <div class="level-item" id="bm">
          <a class="home" href="#"> ‚Üê Back </a>
        </div>
        </div>
        <div class="level-item has-text-center">
          <h1 class="title">Go build</h1>
        </div>
      </nav>

      <div class="box">
        <div class="container">
          <div class="level">
            <div id="did" class="file has-name level-item">
              <label class="file-label">
                <input class="file-input" id="d2b" type="file" name="d2b" webkitdirectory>
                <span class="file-cta">
                  <span class="file-icon">
                    <i class="fa fa-upload"></i>
                  </span>
                  <span class="file-label has-text-centered">
                    Select the directory ...
                  </span>
                </span>
                <input class="file-name" id="pn" placeholder="Project Name...">
              </label>
            </div>

            <div class="makefile level-item">
              <label>
                <input id="gm" type="checkbox" name="gm" checked>
                <span>Generate a goreleaser</span>
              </label>
            </div>
            <button class="button" id="bb" type="button" name="button">Build</button>
          </div>
        </div>
      </div>

      <div class="box">
        <div id="gtd" class="container">
          <div class="file has-name level-item">
            <label class="file-label">
              <span class="file-cta">
                <span class="file-label has-text-centered">
                  Github token
                </span>
              </span>
              <input class="input" id="gt" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
            </label>
          </div>
        </div>
     </div>

      <div class="box">
        <div class="container">
          <div class="level">
            <div class="level-item">
              <dl class="">
                <dt>
                  <a href="#"><span>GOOS</span></a>
                </dt>
                <dd>
                  <ul>
                    <li><label><input name="goos" type="checkbox" value="android" />Android</label></li>
                    <li><label><input name="goos" type="checkbox" value="darwin" />Darwin</label></li>
                    <li><label><input name="goos" type="checkbox" value="freebsd" />Free BSD</label></li>
                    <li><label><input name="goos" type="checkbox" value="linux" />Linux</label></li>
                    <li><label><input name="goos" type="checkbox" value="windows" />Windows</label></li>
                  </ul>
                </dd>
              </dl>
            </div>

            <div class="level-item">
              <dl class="">
                <dt>
                  <a href="#"><span>GOARCH</span></a>
                </dt>
                <dd>
                  <div>
                    <ul>
                      <li><label><input name="goarch" type="checkbox" value="amd64" />Amd</label></li>
                      <li><label><input name="goarch" type="checkbox" value="arm" />Arm</label></li>
                      <li><label><input name="goarch" type="checkbox" value="Windows" />Arm64</label></li>
                    </ul>
                  </div>
                </dd>
              </dl>
            </div>

            <div class="level-item">
              <dl>
                <dt>
                  <a href="#"><span>ARCHIVE</span></a>
                </dt>
                <dd>
                  <div id="af">
                    <ul>
                      <li><label><input name="archive" type="checkbox" value="tar.gz" />tar.gz</label></li>
                      <li><label><input name="archive" type="checkbox" value="zip" />zip</label><li>
                      <li><label><input name="archive" type="checkbox" value="gzip" />gzip</label></li>
                    </ul>
                  </div>
                </dd>
              </dl>
            </div>

          </div>
        </div>
      </div>

      <div class="box">
        <div class="container">
          <div class="level">
            Git tag
            <label for="version">Version</label>
            <div class="level-item control">
            <input class="input" type="text" name="version">
            </div>
            <label for="tag_message">Message</label>
            <div class="level-item control">
            <input class="input "type="text" name="tag_message">
            </div>
          </div>
         </div>
      </div>

      <div class="hero is-danger is-large has-text-left">
        <div class="hero-body">
          <div class="errors container" id="gcc_errors">
            <h4 class="title is-1">Errors</h4>
          </div>
          <div id="gr_errors"> </div>
       </div>
      </div>
    </section>

    <script type="text/javascript">
      const {dialog} = require('electron').remote;
      const fs = require('fs');

      let cmd;
      let dir;
      let elogs;
      let git_token;
      let logpath;
      let logs;
      let path;
      let projectName;
      let message = "First release"
      let settings = {
        "build":{
          'goos': [],
          'goarch': []
        },
        "archive":{
          "wanted": false,
          "format": ""
        }
      };
      let tag_message;
      let tag_version;

      $('#d2b').on('click', function(e){
        e.preventDefault();
        path = dialog.showOpenDialog({
          properties: ['openDirectory']
        })
      })

      $("input[name='archive']").click(function(){
        if($(this).is(":checked")){
          $("input[name='archive']").prop("checked", false);
          $(this).prop("checked", true);
        }
      });

      $("#bb").click(function(){

        settings = { "build":{ "goos": [], "goarch": []},"archive":{"wanted": false, "format": ""}};

        logpath = path + '/logs'
        if (!fs.existsSync(logpath)){
          shell.mkdir(logpath)
        }

        if(!$("#gt").val()){
          $("#gt").addClass("is-danger");
          $("#gtd").append("<p class='help is-danger'>The github token is required</p>");
          return ;
        }
        else{
            git_token = $("#gt").val();
            process.env.GITHUB_TOKEN = git_token;
            console.log(git_token);
        }

        projectName = ($("#pn").val()) ? $("#pn").val() : 'impala';

        $("input[name='goos']:checked").each(function(){
          settings['build']['goos'].push($(this).val());
        });

        $("input[name='goarch']:checked").each(function(){
          settings['build']['goarch'].push($(this).val());
        });

        settings['archive']['format'] = $("input[name='archive']:checked").val();

        if(settings['archive']['format'] !== 'undefined'){
          settings['archive']['wanted'] = true;
        }

        makeGoreleaser(projectName, path, settings);

        tag_message = $("input[name='tag_message']").val();
        tag_version = $("input[name='version']").val();

        elogs = path + "/logs/goreleaser_errors.log";
        logs = path + "/logs/impala_log.log";

        cmd = "cd " + path + " && git add . && git commit -m 'commit before release' "
        cmd += "&& git tag -a " + tag_version + " -m '"  + tag_message + "' "
        cmd += "&& goreleaser --rm-dist && git add . && git commit -m 'goreleaser builds' && git push"
        shell.exec(cmd);
        printLogs(elogs);
      })

      function printLogs(file){
        errs = '<p class="subtitle">'
        fs.readFile(file, 'utf8', function (err, data) {
          console.log(data);
          if (err) {
            return console.log('err: ' + err);
          }
          data = data.split('\n');
          for(let i = 0, len = data.length; i < len; i++){
            data[i] += '</p><pclass="subtitle">'
            errs += data[i];
          }
          errs += '</p>';
          $("#gr_errors").html(errs);
        });
      }
    </script>
  </body>
</html>
