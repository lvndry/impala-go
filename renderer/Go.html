<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Go Impala</title>

  <link rel="stylesheet" href="../assets/style/go.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.1/css/bulma.css">

  <script type="text/javascript" src="../script/goreleaser.js"></script>
  <script>
    if (typeof module === 'object') {
      window.module = module;
      module = undefined;
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script>
    if (window.module) module = window.module;
  </script>
</head>

<body>
  <section class="section">

    <nav class="level">
      <div class="level-left">
        <div class="level-item" id="bm">
          <a class="home" href="#"> ‚Üê Back </a>
        </div>
      </div>
      <div class="level-item has-text-center">
        <h1 class="title">Go build</h1>
      </div>
    </nav>

    <div class="box">
      <div class="container">
        <div class="level">
          <div id="did" class="file has-name level-item">
            <label class="file-label">
                <input class="file-input" id="d2b" type="file" name="d2b" webkitdirectory>
                <span class="file-cta">
                  <span class="file-icon">
                    <i class="fa fa-upload"></i>
                  </span>
                  <span class="file-label has-text-centered">
                    Select the directory ...
                  </span>
                </span>
                <input class="file-name" id="pn" placeholder="Project Name...">
              </label>
          </div>

          <div class="makefile level-item">
            <label>
                <input id="gm" type="checkbox" name="gm" checked>
                <span>Generate a goreleaser</span>
              </label>
          </div>
          <button class="button" id="bb" type="button" name="button">Build</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div id="gtd" class="container">
        <div class="file has-name level-item">
          <label class="file-label">
              <span class="file-cta">
                <span class="file-label has-text-centered">
                  Github token
                </span>
              </span>
              <input class="input" id="gt" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" required>
            </label>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="container">
      <table class="table is-hoverable is-fullwidth">
        <thead>
          <th><a href="#">GOOS</th></a>
            <th><a href="#">GOARCH</th></a>
          <th><a href="#">ARCHIVE</th></a>
        </thead>
        <tbody>
          <tr>
            <td><input name="goos" type="checkbox" value="android" /><label>Android</label></td>
            <td><input name="goarch" type="checkbox" value="386" /><label>386</label></td>
            <td><input name="archive" type="checkbox" value="tar.gz" /><label>tar.gz</label></td>
          </tr>
          <tr>
            <td><input name="goos" type="checkbox" value="darwin" /><label>Darwin</label></td>
            <td><input name="goarch" type="checkbox" value="amd64" /><label>AMD</label></td>
            <td><input name="archive" type="checkbox" value="zip" /><label>zip</label></td>
          </tr>
          <tr>
            <td><input name="goos" type="checkbox" value="freebsd" /><label>Free BSD</label></td>
            <td><input name="goarch" type="checkbox" value="arm" /><label>ARM</label></td>
            <td><input name="archive" type="checkbox" value="gzip" /><label>gzip</label></td>
          </tr>
          <tr>
            <td><input name="goos" type="checkbox" value="linux" /><label>Linux</label></td>
            <td><input name="goarch" type="checkbox" value="arm64" /><label>ARM64</label></td>
            <td></td>
          </tr>
          <tr>
            <td><input name="goos" type="checkbox" value="solaris" /><label>Solaris</label></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td><input name="goos" type="checkbox" value="windows" /><label>Windows</label></td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      </div>
    </div>

    <div class="box">
      <div class="container">
        <div class="level gtag">
          Git tag
          <div class="level-item">
            <label for="version">Version</label>
            <div class="control">
              <input class="input" type="text" name="version">
            </div>
          </div>
          <div class="level-item">
            <label for="tag_message">Message</label>
            <div class="control">
              <input class="input " type="text" name="tag_message">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hero is-danger is-large has-text-left">
      <div class="hero-body">
        <div class="errors container" id="gcc_errors">
          <h4 class="title is-1">Errors</h4>
        </div>
        <div id="gr_errors"> </div>
      </div>
    </div>
  </section>

  <script type="text/javascript">
    const {
      dialog
    } = require('electron').remote;
    const fs = require('fs');

    let cmd;
    let combinaisons = {
      "android": ["386", "amd64", "arm", "arm64"],
      "darwin": ["amd64", "arm", "arm64"],
      "dragonfly": ["amd64"],
      "freebsd": ["386", "amd64"],
      "linux": ["386", "amd64", "arm", "arm64", "ppc64le"],
      "netbsd": ["386", "amd64", "arm"],
      "openbsd": ["386", "amd64"],
      "solaris": ["amd64"],
      "windows": ["386", "amd64"]
    };
    let dir;
    let elogs;
    let git_token;
    let logpath;
    let logs;
    let path;
    let projectName;
    let message;
    let settings = {
      "name": "",
      "path": "",
      "build": {
        'goos': [],
        'goarch': []
      },
      "archive": {
        "wanted": false,
        "format": ""
      }
    };
    let tag_message;
    let tag_version;

    $('#d2b').on('click', function(e) {
      e.preventDefault();
      path = dialog.showOpenDialog({
        properties: ['openDirectory']
      })
      settings['path'] = path;
    });

    function combine(value) {
        $("input[name='goos']").each(function() {
          $(this).prop("disabled", false);
        });

        $("input[name='goarch']").each(function() {
          $(this).prop("disabled", false);
        });

        let checkedOs = [];
        $("input[name='goos']:checked").each(function() {
          checkedOs.push($(this).val());
        });

        for (let i = 0, clen = checkedOs.length; i < clen; i++) {
          $("input[name='goarch']").each(function() {
            let name = $(this).val();
            if (combinaisons[checkedOs[i]].indexOf(name) === -1) {
              $(this).prop("disabled", true);
            }
          });
        }

        let checkedArch = [];
        $("input[name='goarch']:checked").each(function() {
          checkedArch.push($(this).val())
        });

        for (let i = 0, clen = checkedArch.length; i < clen; i++) {
          $("input[name='goos']").each(function() {
            let name = $(this).val();
            if (combinaisons[name].indexOf(checkedArch[i]) === -1) {
              $(this).prop("disabled", true);
            }
          });
        }
    }

    $("input[name='goos']").click(function(e) {
      combine(e.currentTarget.value);
    });

    $("input[name='goarch']").click(function(e) {
      combine(e.currentTarget.value);
    });

    $("input[name='archive']").click(function() {
      if ($(this).is(":checked")) {
        $("input[name='archive']").prop("checked", false);
        $(this).prop("checked", true);
      }
    });

    $("#bb").click(function() {

      settings = {
        "name": "",
        "path": "",
        "build": {
          "goos": [],
          "goarch": []
        },
        "archive": {
          "wanted": false,
          "format": ""
        }
      };

      logpath = path + '/logs'
      if (!fs.existsSync(logpath)) {
        shell.mkdir(logpath)
      }

      if (!$("#gt").val()) {
        if (process.env.GITHUB_TOKEN === "undefined") {
          $("#gt").addClass("is-danger");
          $("#gtd").append("<p class='help is-danger'>The github token is required</p>");

          return;
        }
      } else {
        console.log('tok1: ' + process.env.GITHUB_TOKEN);
        git_token = $("#gt").val();
        process.env.GITHUB_TOKEN = git_token;
        console.log('tk2: ' + process.env.GITHUB_TOKEN);
      }

      settings['name'] = ($("#pn").val()) ? $("#pn").val() : 'impala';
      $("input[name='goos']:checked").each(function() {
        settings['build']['goos'].push($(this).val());
      });

      $("input[name='goarch']:checked").each(function() {
        settings['build']['goarch'].push($(this).val());
      });

      settings['archive']['format'] = $("input[name='archive']:checked").val();

      if (settings['archive']['format'] !== 'undefined') {
        settings['archive']['wanted'] = true;
      }

      makeGoreleaser(settings);

      tag_message = $("input[name='tag_message']").val();
      tag_version = $("input[name='version']").val();

      elogs = path + "/logs/goreleaser_errors.log";
      logs = path + "/logs/impala_log.log";

      cmd = "cd " + path + " && git add . && git commit -m 'commit before release' "
      cmd += "&& git tag -a " + tag_version + " -m '" + tag_message + "' "
      cmd += "&& goreleaser --rm-dist && git add . && git commit -m 'goreleaser builds' && git push"
      shell.exec(cmd);
      printLogs(logs);
    })

    function printLogs(file) {
      errs = '<p class="subtitle">'
      fs.readFile(file, 'utf8', function(err, data) {
        console.log(data);
        if (err) {
          return console.log('err: ' + err);
        }
        data = data.split('\n');
        for (let i = 0, len = data.length; i < len; i++) {
          data[i] += '</p><pclass="subtitle">'
          errs += data[i];
        }
        errs += '</p>';
        $("#gr_errors").html(errs);
      });
    }
  </script>
</body>

</html>
<!-- TODO goreleaser a dev, changer dans le box en array goos goarch archive html  -->
